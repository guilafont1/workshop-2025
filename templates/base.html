<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Virus.Life</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="site-header">
    <div class="container header-grid">
      <div class="brand">
        <h1>üß¨ Virus.Life</h1>
        <div class="subtitle">Escape game - s√©curit√© & m√©decine</div>
      </div>
      <nav class="main-nav">
        <a href="{{ url_for('index') }}">Accueil</a>
        <a href="{{ url_for('lobby') }}">Lobby</a>
        <button onclick="showInstructions()" style="background:none;border:1px solid var(--accent-2);color:var(--accent-2);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:14px;">Instructions</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <div class="card small">
        <strong>√âquipe</strong>
        <div class="muted">{{ state.team_name or '‚Äî' }}</div>
      </div>
      <div class="card small">
        <strong>Progression</strong>
        <ul class="progress-list"¬≤>
          {% for r, done in state.progress.items() %}
            <li class="progress-item {% if done %}done{% else %}locked{% endif %}">
              {{ r.replace('room','Salle ') }} ‚Äî {% if done %}‚úì Termin√©{% else %}üîí Verrouill√©{% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
      <div class="card small">
        <strong>Temps restant</strong>
        <div id="time-left-display" data-seconds="{{ state.time_left_seconds or '' }}">
          <div class="muted" id="time-left-text">{{ state.time_left_str or '‚Äî' }}</div>
        </div>
        <div id="time-up-msg" class="msg {% if not state.time_up %}hidden{% endif %}" style="margin-top:8px">Temps √©coul√©¬†: la partie est termin√©e.</div>
      </div>
    </aside>

    <section class="content">
      {% block content %}{% endblock %}
    </section>
  </main>

  <!-- Instructions Popup -->
  <div id="instructions-popup" class="popup-overlay" style="display:none;">
    <div class="popup">
      <div class="popup-header">
        <h3 class="popup-title">üè• Instructions m√©dicales d'urgence</h3>
        <button class="popup-close" onclick="hideInstructions()">‚úï</button>
      </div>
      <div class="popup-content">
        <p><strong>Contexte :</strong> Vous √™tes une √©quipe m√©dicale dans un h√¥pital en quarantaine suite √† une √©pid√©mie virale. Vous devez r√©soudre les d√©fis pour sauver les patients et contenir la propagation.</p>
        
        <p><strong>Objectif :</strong> Progresser √† travers les 6 salles en r√©solvant les √©nigmes m√©dicales complexes dans le temps imparti.</p>
        
        <div class="equipment-grid" style="margin: 16px 0;">
          <div class="equipment-item">
            <strong>ü´Ä Diagnostic</strong>
            <br><small>Analysez les donn√©es vitales</small>
          </div>
          <div class="equipment-item">
            <strong>üß¨ G√©n√©tique</strong>
            <br><small>D√©cryptez les s√©quences</small>
          </div>
          <div class="equipment-item">
            <strong>ü¶† Confinement</strong>
            <br><small>S√©curisez le laboratoire</small>
          </div>
        </div>

        <p><strong>Conseils :</strong></p>
        <ul style="margin-left: 20px;">
          <li>Lisez attentivement tous les indices</li>
          <li>Les r√©ponses sont souvent cach√©es dans les d√©tails</li>
          <li>Travaillez en √©quipe pour analyser les donn√©es</li>
          <li>Attention au temps - l'√©pid√©mie progresse !</li>
        </ul>
      </div>
      <div class="popup-buttons">
        <button class="popup-btn primary" onclick="hideInstructions()">Commencer la mission</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container">
      <small>&copy; Workshop EPSI/WIS ‚Äî Escape Game M√©dical</small>
    </div>
  </footer>
  <script>
    // Instructions popup functions
    function showInstructions() {
      document.getElementById('instructions-popup').style.display = 'flex';
    }
    
    function hideInstructions() {
      document.getElementById('instructions-popup').style.display = 'none';
    }

    // Live countdown: reads initial seconds from #time-left-display[data-seconds]
    (function(){
      function qs(id){return document.getElementById(id)}
      var el = qs('time-left-display');
      if(!el) return;
      var sec = parseInt(el.getAttribute('data-seconds')||'0');
      var text = qs('time-left-text');
      var upmsg = qs('time-up-msg');
      function fmt(s){
        var m = Math.floor(s/60);
        var ss = s%60;
        return m + ':' + (ss<10? '0'+ss : ss);
      }
      if(isNaN(sec) || sec<=0){
        if(upmsg) upmsg.classList.remove('hidden');
        if(text) text.textContent = '0:00';
        return;
      }
      text.textContent = fmt(sec);
      var iv = setInterval(function(){
        sec--;
        if(sec<=0){
          if(text) text.textContent = '0:00';
          if(upmsg) upmsg.classList.remove('hidden');
          clearInterval(iv);
          // redirect to /fail to ensure server-side handling
          try{ window.location = '{{ url_for("fail") }}'; }catch(e){window.location = '/fail';}
          return;
        }
        if(text) text.textContent = fmt(sec);
        
        // Add urgency effects when time is low
        if(sec <= 60 && text) {
          text.style.color = '#ff4757';
          text.style.fontWeight = 'bold';
          if(sec <= 30) {
            text.style.animation = 'pulse 1s infinite';
          }
        }
      },1000);
    })();
  </script>
</body>
</html>
