{% extends "base.html" %}

{% block content %}
<div class="card">
  <h2>🌡️ Salle 3 — Hydratation et température</h2>

  <div class="alert">
    <strong>ANOMALIE DÉTECTÉE :</strong> Le virus a corrompu les calculs d'hydratation !<br>
    Les formules médicales sont mélangées et les besoins en eau sont incorrects.
  </div>

  <p><strong>Mission :</strong> Calculez les besoins d'hydratation précis en tenant compte de TOUS les facteurs médicaux !</p>
  <p><em>Durée estimée : 8-12 minutes — Puzzle médical avancé avec calculs complexes</em></p>

  <div class="current-data">
    <h4>🏥 Données patients détaillées</h4>

    <div class="patients-grid">
      {% for patient in hydration_data.patients %}
      <div class="patient-detail-card">
        <h5>{{ patient.nom }}</h5>

        <div class="patient-stats">
          <div class="stat-item">
            <span class="label">🌡️ Température:</span>
            <span class="value temp">{{ patient.temperature }}°C</span>
          </div>
          <div class="stat-item">
            <span class="label">⚖️ Poids:</span>
            <span class="value">{{ patient.poids }}kg</span>
          </div>
          <div class="stat-item">
            <span class="label">👤 Âge:</span>
            <span class="value">{{ patient.age }} ans</span>
          </div>
          <div class="stat-item">
            <span class="label">🩺 Pathologie:</span>
            <span class="value pathology">{{ patient.pathologie }}</span>
          </div>
          <div class="stat-item">
            <span class="label">🚨 Facteur fièvre:</span>
            <span class="value fever-factor">{{ patient.facteur_fievre }}</span>
          </div>
        </div>

        <div class="current-hydration">
          💧 Hydratation actuelle: <strong>{{ patient.hydratation_actuelle }}L/jour</strong>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="calculation-tools">
    <h4>🧮 Outils de calcul médical</h4>

    <div class="medical-formulas">
      <div class="formula-card">
        <h5>📊 Formule de base</h5>
        <div class="formula">
          <strong>Hydratation = 30ml × Poids (kg) + Ajustements</strong>
        </div>
        <div class="formula-details">
          Base de 30ml par kg de poids corporel
        </div>
      </div>

      <div class="formula-card">
        <h5>🌡️ Ajustement fièvre</h5>
        <div class="formula">
          <strong>+13% par degré au-dessus de 37°C</strong>
        </div>
        <div class="formula-details">
          Chaque degré de fièvre augmente les besoins de 13%
        </div>
      </div>

      <div class="formula-card">
        <h5>👴 Facteur âge</h5>
        <div class="formula">
          <strong>65+ ans : -10% | 18-35 ans : +5%</strong>
        </div>
        <div class="formula-details">
          Les seniors ont moins de sensation de soif
        </div>
      </div>

      <div class="formula-card">
        <h5>🩺 Pathologies</h5>
        <div class="formula">
          <strong>Insuffisance cardiaque : -20%</strong><br>
          <strong>Insuffisance rénale : -15%</strong><br>
          <strong>Diabète : +10%</strong><br>
          <strong>Infection : +15%</strong>
        </div>
        <div class="formula-details">
          Ajustements selon conditions médicales
        </div>
      </div>
    </div>
  </div>

  <div class="calculator-section">
    <h4>🔢 Calculatrice médicale intégrée</h4>

    <div class="calculator-grid">
      {% for patient in hydration_data.patients %}
      <div class="calc-card">
        <h5>Calcul pour {{ patient.nom }}</h5>

        <div class="calc-steps">
          <div class="step">
            <span class="step-label">1. Base (30ml × {{ patient.poids }}kg):</span>
            <span class="step-value">{{ (patient.poids * 30)|round(0)|int }}ml</span>
          </div>
          <div class="step">
            <span class="step-label">2. Ajustement fièvre ({{ patient.temperature }}°C):</span>
            <span class="step-value fever">{{ patient.facteur_fievre }}</span>
          </div>
          <div class="step">
            <span class="step-label">3. Facteur âge ({{ patient.age }} ans):</span>
            <span class="step-value age">
              {% if patient.age >= 65 %}-10%
              {% elif patient.age <= 35 %}+5%
              {% else %}0%{% endif %}
            </span>
          </div>
          <div class="step">
            <span class="step-label">4. Pathologie ({{ patient.pathologie }}):</span>
            <span class="step-value pathology">
              {% if "cardiaque" in patient.pathologie %}-20%
              {% elif "rénale" in patient.pathologie %}-15%
              {% elif "diabète" in patient.pathologie %}+10%
              {% elif "infection" in patient.pathologie %}+15%
              {% else %}0%{% endif %}
            </span>
          </div>
        </div>

        <div class="calc-hint">
          💡 <em>Calculez étape par étape puis convertissez en L/jour</em>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="hint-section">
    <h4>💡 Guide de calcul avancé</h4>

    <div class="hint-box">
      <p><strong>Exemple de calcul complet :</strong></p>
      <p>Patient 70kg, 38.5°C, 70 ans, diabète :</p>
      <p>1. Base : 70 × 30 = 2100ml</p>
      <p>2. Fièvre : +1.5°C = +19.5% → 2100 × 1.195 = 2509ml</p>
      <p>3. Âge 70 ans : -10% → 2509 × 0.9 = 2258ml</p>
      <p>4. Diabète : +10% → 2258 × 1.1 = 2484ml</p>
      <p><strong>Résultat : 2484ml = 2.5L/jour</strong></p>
    </div>
  </div>

  {% if message %}
  <div class="msg">{{ message }}</div>
  {% endif %}

  <div class="solution-form">
    <h4>💧 Prescriptions d'hydratation calculées</h4>

    <form method="post">
      <div class="hydration-grid">
        {% for patient in hydration_data.patients %}
        <div class="hydration-card">
          <h5>{{ patient.nom }}</h5>

          <div class="patient-summary">
            <div class="summary-item">🌡️ {{ patient.temperature }}°C</div>
            <div class="summary-item">⚖️ {{ patient.poids }}kg</div>
            <div class="summary-item">👤 {{ patient.age }} ans</div>
            <div class="summary-item">🩺 {{ patient.pathologie }}</div>
          </div>

          <div class="water-input">
            <label>💧 Hydratation calculée (L/jour) :</label>
            <select name="{{ patient.nom }}" required>
              <option value="">Calculer et choisir...</option>
              {% for amount in hydration_data.options_calcul %}
              <option value="{{ amount }}">{{ amount }}L</option>
              {% endfor %}
            </select>
          </div>

          <div class="calculation-reminder">
            🧮 Utilisez la calculatrice ci-dessus !
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="submit-section">
        <button type="submit">🩺 Valider les calculs d'hydratation</button>
      </div>
    </form>
  </div>

  <div class="reference-guide">
    <h4>📚 Références médicales</h4>

    <div class="reference-grid">
      <div class="ref-card">
        <h6>🌡️ Échelle de température</h6>
        <div class="temp-ref">
          <div class="temp-line normal">36.1-37.2°C : Normal</div>
          <div class="temp-line subfebrile">37.3-38.0°C : Subfébrile</div>
          <div class="temp-line moderate">38.1-39.0°C : Fièvre modérée</div>
          <div class="temp-line high">39.1-40.0°C : Fièvre élevée</div>
        </div>
      </div>

      <div class="ref-card">
        <h6>💧 Besoins normaux</h6>
        <div class="hydration-ref">
          <div>Adulte standard : 30-35ml/kg</div>
          <div>Personne âgée : 25-30ml/kg</div>
          <div>Avec fièvre : +13%/°C</div>
          <div>Minimum vital : 1.5L/jour</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.patients-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.patient-detail-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  border: 2px solid #1976d2;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.patient-detail-card h5 {
  margin: 0 0 15px 0;
  color: #0d47a1;
  font-size: 18px;
  text-align: center;
  border-bottom: 2px solid #1976d2;
  padding-bottom: 8px;
}

.patient-stats {
  display: grid;
  gap: 8px;
  margin-bottom: 15px;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.7);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #90caf9;
}

.stat-item .label {
  font-weight: bold;
  color: #1565c0;
}

.stat-item .value {
  font-weight: bold;
  color: #0d47a1;
}

.stat-item .value.temp {
  color: #d32f2f;
}

.stat-item .value.pathology {
  color: #7b1fa2;
}

.stat-item .value.fever-factor {
  color: #f57c00;
}

.current-hydration {
  background: rgba(33, 150, 243, 0.15);
  color: #0d47a1;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  border: 2px solid #2196f3;
  font-size: 14px;
}

.medical-formulas {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.formula-card {
  background: linear-gradient(135deg, #f3e5f5, #e1bee7);
  border: 2px solid #9c27b0;
  border-radius: 12px;
  padding: 15px;
}

.formula-card h5 {
  margin: 0 0 10px 0;
  color: #4a148c;
  font-size: 16px;
  text-align: center;
  border-bottom: 2px solid #9c27b0;
  padding-bottom: 8px;
}

.formula {
  background: rgba(255,255,255,0.8);
  padding: 10px;
  border-radius: 8px;
  margin: 10px 0;
  border: 1px solid #ab47bc;
  text-align: center;
  color: #4a148c;
}

.formula-details {
  font-style: italic;
  color: #7b1fa2;
  font-size: 12px;
  text-align: center;
}

.calculator-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.calc-card {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
  border: 2px solid #ff9800;
  border-radius: 12px;
  padding: 20px;
}

.calc-card h5 {
  margin: 0 0 15px 0;
  color: #e65100;
  text-align: center;
  border-bottom: 2px solid #ff9800;
  padding-bottom: 8px;
}

.calc-steps {
  display: grid;
  gap: 10px;
  margin-bottom: 15px;
}

.step {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.7);
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #ffb74d;
}

.step-label {
  font-size: 13px;
  color: #ef6c00;
}

.step-value {
  font-weight: bold;
  color: #bf360c;
}

.step-value.fever {
  color: #d32f2f;
}

.step-value.age {
  color: #1976d2;
}

.step-value.pathology {
  color: #7b1fa2;
}

.calc-hint {
  background: rgba(255, 193, 7, 0.2);
  padding: 8px;
  border-radius: 6px;
  text-align: center;
  font-size: 12px;
  color: #f57c00;
  border: 1px solid #ffa726;
}

.hint-box {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
  border: 2px solid #4caf50;
  border-radius: 12px;
  padding: 20px;
  color: #1b5e20;
  font-size: 14px;
}

.hint-box p {
  margin: 5px 0;
}

.solution-form {
  background: #f8f9fa;
  border-radius: 15px;
  padding: 25px;
  margin-top: 25px;
  border: 2px solid #1976d2;
}

.hydration-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.hydration-card {
  background: white;
  border: 2px solid #1976d2;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.hydration-card h5 {
  margin: 0 0 15px 0;
  color: #0d47a1;
  font-size: 16px;
  text-align: center;
  border-bottom: 2px solid #1976d2;
  padding-bottom: 8px;
}

.patient-summary {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 15px;
}

.summary-item {
  background: rgba(25, 118, 210, 0.1);
  padding: 6px 8px;
  border-radius: 6px;
  font-size: 12px;
  text-align: center;
  color: #1565c0;
  border: 1px solid #90caf9;
}

.water-input label {
  display: block;
  margin: 10px 0 8px 0;
  color: #0d47a1;
  font-weight: bold;
}

.water-input select {
  width: 100%;
  padding: 12px;
  border: 2px solid #1976d2;
  border-radius: 8px;
  background: white;
  color: #0d47a1;
  font-weight: bold;
  font-size: 14px;
}

.calculation-reminder {
  background: rgba(255, 193, 7, 0.2);
  padding: 8px;
  border-radius: 6px;
  text-align: center;
  font-size: 12px;
  color: #f57c00;
  margin-top: 10px;
  border: 1px solid #ffa726;
}

.submit-section {
  text-align: center;
}

.submit-section button {
  background: linear-gradient(135deg, #1976d2, #42a5f5);
  color: white;
  border: none;
  padding: 15px 40px;
  border-radius: 25px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
}

.submit-section button:hover {
  background: linear-gradient(135deg, #1565c0, #1e88e5);
  box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
  transform: translateY(-2px);
}

.reference-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.ref-card {
  background: linear-gradient(135deg, #fafafa, #f5f5f5);
  border: 2px solid #757575;
  border-radius: 10px;
  padding: 15px;
}

.ref-card h6 {
  margin: 0 0 10px 0;
  color: #424242;
  font-size: 14px;
  text-align: center;
  border-bottom: 1px solid #9e9e9e;
  padding-bottom: 5px;
}

.temp-ref .temp-line {
  padding: 4px 8px;
  margin: 3px 0;
  border-radius: 4px;
  font-size: 12px;
}

.temp-line.normal {
  background: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.temp-line.subfebrile {
  background: rgba(255, 152, 0, 0.2);
  color: #ef6c00;
}

.temp-line.moderate {
  background: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.temp-line.high {
  background: rgba(156, 39, 176, 0.2);
  color: #7b1fa2;
}

.hydration-ref div {
  padding: 3px 0;
  font-size: 12px;
  color: #424242;
}

.alert {
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
  border: 1px solid #f5c6cb;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  color: #721c24;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .patients-grid,
  .medical-formulas,
  .calculator-grid,
  .hydration-grid {
    grid-template-columns: 1fr;
  }

  .patient-summary {
    grid-template-columns: 1fr;
  }

  .calc-steps .step {
    flex-direction: column;
    text-align: center;
  }

  .stat-item {
    flex-direction: column;
    text-align: center;
  }
}
</style>
{% endblock %}